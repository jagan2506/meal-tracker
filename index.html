<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rural School Meal Attendance Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

    
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>


    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .tabs { display: flex; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 5px; margin-bottom: 30px; }
        .tab { flex: 1; padding: 15px; background: transparent; border: none; color: white; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; }
        .tab.active { background: white; color: #667eea; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .tab-content { display: none; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; animation: slideIn 0.5s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102,126,234,0.4); }
        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .btn-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
        .qr-container { text-align: center; padding: 30px; background: #f8f9ff; border-radius: 15px; margin: 20px 0; }
        #qrCode { width: 200px; height: 200px; margin: 20px auto; }
        #scanner-container { position: relative; width: 100%; max-width: 400px; margin: 20px auto; }
        #scanner { width: 100%; border-radius: 15px; }
        .scan-result { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .attendance-list { max-height: 400px; overflow-y: auto; }
        .attendance-item { display: flex; justify-content: space-between; padding: 15px; background: #f8f9fa; margin: 10px 0; border-radius: 10px; border-left: 5px solid #667eea; }
        .voice-feedback { position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 15px; border-radius: 50px; font-size: 14px; box-shadow: 0 10px 30px rgba(40,167,69,0.4); }
        @media (max-width: 768px) { .tabs { flex-direction: column; } .container { padding: 15px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üç≤ Rural School Meal Tracker</h1>
            <p>Prevent malnutrition with QR attendance</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('admin')">üë®‚Äçüè´ Admin Panel</button>
            <button class="tab" onclick="switchTab('scanner')">üì± QR Scanner</button>
            <button class="tab" onclick="switchTab('reports')">üìä Reports</button>
        </div>

        <!-- ADMIN PANEL -->
        <div id="admin" class="tab-content active">
            <h2>Generate Student QR Codes</h2>
            <div class="form-group">
                <label>Student Name *</label>
                <input type="text" id="studentName" placeholder="Enter student name (e.g., Ravi Kumar)">
            </div>
            <div class="form-group">
                <label>Student ID *</label>
                <input type="text" id="studentId" placeholder="STD001">
            </div>
            <div class="form-group">
                <label>Class</label>
                <input type="text" id="studentClass" placeholder="5A">
            </div>
            <button class="btn" onclick="generateQR()">üé® Generate QR Code</button>
            <div id="qrContainer" class="qr-container" style="display:none;">
                <div id="qrCode"></div>

                <p id="qrInfo"></p>
                <button class="btn btn-success" onclick="downloadQR()">‚¨áÔ∏è Download QR</button>
            </div>
        </div>

        <!-- QR SCANNER -->
        <div id="scanner" class="tab-content">
            <h2>Scan Student QR for Meal Attendance</h2>
            <div id="scanner-container">
                <video id="scanner" style="display:none;"></video>
                <div id="scanStatus" style="text-align:center; padding:20px;">
                    <p>üëÜ Tap "Start Scanner" to begin</p>
                    <button class="btn" onclick="startScanner()">üöÄ Start Scanner</button>
                </div>
            </div>
            <div id="scanResult" class="scan-result" style="display:none;"></div>
            <div id="todayAttendance" class="attendance-list"></div>
        </div>

        <!-- REPORTS -->
        <div id="reports" class="tab-content">
            <h2>Attendance Reports</h2>
            <div id="reportData"></div>
            <button class="btn btn-success" onclick="exportExcel()" style="margin:20px 0;">üì• Export to Excel</button>
        </div>
    </div>
    <div id="voiceFeedback" class="voice-feedback" style="display:none;"></div>

   <script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDg3helshzE7cWYepCtAXRovRiSolIQaWY",
        authDomain: "meal-tracker-7785a.firebaseapp.com",
        projectId: "meal-tracker-7785a",
        storageBucket: "meal-tracker-7785a.firebasestorage.app",
        messagingSenderId: "984838923056",
        appId: "1:984838923056:web:2130d454dcab47be651ef5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let html5QrCode;
    let currentDate = new Date().toISOString().split('T')[0];
    let scannedStudents = [];

    // Tab Switching
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        if (tabName === 'scanner') loadTodayAttendance();
        if (tabName === 'reports') loadReports();
    }

    // Generate QR Code (using QRCode.toCanvas on your <canvas>)
    function generateQR() {
    alert("Generate QR clicked");
    const name = document.getElementById('studentName').value.trim();
    const id = document.getElementById('studentId').value.trim();
    const cls = document.getElementById('studentClass').value.trim();

    if (!name || !id) {
        alert('Please enter student name and ID');
        return;
    }

    const studentData = { name, id, class: cls || 'N/A', generated: new Date().toISOString() };

    const qrContainer = document.getElementById('qrContainer');
    const qrInfo = document.getElementById('qrInfo');

    // Clear old QR
    const qrDiv = document.getElementById('qrCode');
    qrDiv.innerHTML = "";

    new QRCode("qrCode", {
        text: JSON.stringify(studentData),
        width: 200,
        height: 200
    });

    qrInfo.innerHTML = `
        <strong>${studentData.name}</strong><br>
        ID: ${studentData.id} | Class: ${studentData.class}
    `;
    qrContainer.style.display = 'block';

    db.collection('students').doc(studentData.id).set(studentData);
    speak(`QR code generated for ${studentData.name}`);
}


    // Download QR
    function downloadQR() {
    const img = document.querySelector('#qrCode img');
    if (!img) { alert("Generate QR first"); return; }
    const link = document.createElement('a');
    link.download = 'student-qr.png';
    link.href = img.src;
    link.click();
}


    // Scanner Functions
    async function startScanner() {
        alert("Start Scanner clicked");
        const scanner = document.getElementById('scanner');
        html5QrCode = new Html5Qrcode("scanner-container");

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        await html5QrCode.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanError
        );

        document.getElementById('scanStatus').innerHTML = '<p>üì∑ Scanning... Point camera at QR code</p>';
        scanner.style.display = 'block';
    }

    function onScanSuccess(decodedText, decodedResult) {
        try {
            const student = JSON.parse(decodedText);
            logAttendance(student);
        } catch (e) {
            showScanResult('‚ùå Invalid QR Code', 'error');
        }
    }

    function onScanError() {
        // Silent fail
    }

    async function logAttendance(student) {
        const timestamp = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
        const attendance = {
            name: student.name,
            id: student.id,
            class: student.class || 'N/A',
            time: timestamp,
            date: currentDate,
            status: 'present'
        };

        await db.collection('attendance').doc(`${currentDate}_${student.id}`).set(attendance);

        scannedStudents.push(attendance);
        showScanResult(`‚úÖ ${student.name} marked present at ${new Date().toLocaleTimeString('en-IN')}`, 'success');
        speak(`Namaste! ${student.name} ji ka khana record ho gaya`);

        html5QrCode.clear();
        setTimeout(startScanner, 2000);
    }

    function showScanResult(message, type) {
        const resultDiv = document.getElementById('scanResult');
        resultDiv.innerHTML = message;
        resultDiv.className = type === 'success' ? 'scan-result' : 'scan-result error';
        resultDiv.style.display = 'block';
        setTimeout(() => resultDiv.style.display = 'none', 5000);
    }

    async function loadTodayAttendance() {
        const snapshot = await db.collection('attendance')
            .where('date', '==', currentDate)
            .orderBy('time', 'desc')
            .limit(50).get();

        const list = document.getElementById('todayAttendance');
        list.innerHTML = snapshot.docs.map(doc => {
            const data = doc.data();
            return `
                <div class="attendance-item">
                    <span><strong>${data.name}</strong> (${data.class})</span>
                    <span>${data.time}</span>
                </div>
            `;
        }).join('');
    }

    async function loadReports() {
        const snapshot = await db.collection('attendance').get();
        const reportDiv = document.getElementById('reportData');
        const attendanceByDate = {};

        snapshot.docs.forEach(doc => {
            const data = doc.data();
            if (!attendanceByDate[data.date]) attendanceByDate[data.date] = [];
            attendanceByDate[data.date].push(data);
        });

        reportDiv.innerHTML = Object.entries(attendanceByDate)
            .map(([date, students]) => `
                <div style="margin:20px 0; padding:20px; background:#f8f9fa; border-radius:10px;">
                    <h3>${date}: ${students.length} students attended</h3>
                    <p>Missing: ${50 - students.length} students (target: 50)</p>
                </div>
            `).join('');
    }

    function exportExcel() {
        const wb = XLSX.utils.book_new();
        const wsData = [['Name', 'ID', 'Class', 'Date', 'Time', 'Status']];

        scannedStudents.forEach(student => {
            wsData.push([
                student.name,
                student.id,
                student.class,
                student.date,
                student.time,
                student.status
            ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, 'Meal Attendance');
        XLSX.writeFile(wb, `meal_attendance_${currentDate}.xlsx`);
        speak('Excel report downloaded successfully');
    }

    // Voice Feedback
    function speak(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'hi-IN';
        utterance.rate = 0.9;
        speechSynthesis.speak(utterance);

        const feedback = document.getElementById('voiceFeedback');
        feedback.textContent = text;
        feedback.style.display = 'block';
        setTimeout(() => feedback.style.display = 'none', 3000);
    }

    // Auto-load scanner on mobile
    if (/Android|iPhone/i.test(navigator.userAgent)) {
        setTimeout(() => {
            if (document.visibilityState === 'visible') {
                switchTab('scanner');
            }
        }, 1000);
    }
</script>

</body>
</html>
